-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.achievements (
  id integer NOT NULL DEFAULT nextval('achievements_id_seq'::regclass),
  code character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  xp_reward integer DEFAULT 0,
  icon_name character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT achievements_pkey PRIMARY KEY (id)
);
CREATE TABLE public.action_items (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  inspection_id bigint,
  inspection_item_id bigint,
  title text NOT NULL,
  what_description text,
  where_location text,
  why_reason text,
  how_method text,
  who_responsible text,
  when_deadline date,
  how_much_cost text,
  status text DEFAULT 'pending'::text,
  priority text DEFAULT 'media'::text,
  is_ai_generated boolean DEFAULT false,
  assigned_to uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  type USER-DEFINED DEFAULT 'inspection_action'::action_item_type,
  source USER-DEFINED DEFAULT 'inspection'::action_item_source,
  description text,
  organization_id bigint,
  created_by uuid,
  google_event_id text,
  notification_emails ARRAY,
  CONSTRAINT action_items_pkey PRIMARY KEY (id),
  CONSTRAINT action_items_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT action_items_inspection_item_id_fkey FOREIGN KEY (inspection_item_id) REFERENCES public.inspection_items(id),
  CONSTRAINT action_items_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.users(id),
  CONSTRAINT action_items_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT action_items_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.action_plans (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  organization_id bigint,
  created_by uuid,
  description text NOT NULL,
  priority text NOT NULL CHECK (priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  status text NOT NULL DEFAULT 'open'::text CHECK (status = ANY (ARRAY['open'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  due_date timestamp with time zone,
  inspection_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT action_plans_pkey PRIMARY KEY (id),
  CONSTRAINT action_plans_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT action_plans_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.activity_log (
  id integer NOT NULL DEFAULT nextval('activity_log_id_seq'::regclass),
  user_id uuid,
  organization_id bigint,
  action_type text NOT NULL,
  action_description text,
  target_type text,
  target_id text,
  created_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  ip_address text,
  user_agent text,
  CONSTRAINT activity_log_pkey PRIMARY KEY (id),
  CONSTRAINT activity_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT activity_log_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.ai_assistants (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL,
  description text,
  specialization text,
  instructions text,
  model text DEFAULT 'gpt-4'::text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_assistants_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ai_credits_ledger (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id bigint NOT NULL,
  amount integer NOT NULL,
  balance_after integer NOT NULL,
  transaction_type text NOT NULL CHECK (transaction_type = ANY (ARRAY['purchase'::text, 'monthly_grant'::text, 'usage'::text, 'bonus'::text, 'expiration'::text, 'correction'::text])),
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_credits_ledger_pkey PRIMARY KEY (id),
  CONSTRAINT ai_credits_ledger_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.ai_usage_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id bigint,
  user_id uuid,
  feature_type text NOT NULL DEFAULT 'analysis'::text,
  model_used text NOT NULL DEFAULT 'gemini-flash'::text,
  input_tokens integer DEFAULT 0,
  output_tokens integer DEFAULT 0,
  cost_usd numeric DEFAULT 0,
  status text DEFAULT 'success'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_usage_log_pkey PRIMARY KEY (id),
  CONSTRAINT ai_usage_log_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.ai_usage_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  organization_id bigint,
  user_id uuid,
  feature_type text NOT NULL,
  model_used text NOT NULL,
  total_tokens integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_usage_logs_pkey PRIMARY KEY (id),
  CONSTRAINT ai_usage_logs_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT ai_usage_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.calendar_events (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  organization_id bigint,
  created_by uuid,
  title text NOT NULL,
  description text,
  start_time timestamp with time zone NOT NULL,
  end_time timestamp with time zone NOT NULL,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['inspection'::text, 'meeting'::text, 'focus_time'::text, 'blocking'::text, 'other'::text])),
  status text NOT NULL DEFAULT 'scheduled'::text CHECK (status = ANY (ARRAY['scheduled'::text, 'completed'::text, 'cancelled'::text, 'rescheduled'::text])),
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  participants jsonb DEFAULT '[]'::jsonb,
  scope_items jsonb DEFAULT '[]'::jsonb,
  attachments jsonb DEFAULT '[]'::jsonb,
  location text,
  meeting_link text,
  google_event_id text,
  notification_body text,
  company_name text,
  client_id text,
  accepted_by jsonb DEFAULT '[]'::jsonb,
  declined_by jsonb DEFAULT '[]'::jsonb,
  CONSTRAINT calendar_events_pkey PRIMARY KEY (id),
  CONSTRAINT calendar_events_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT calendar_events_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.checklist_fields (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  template_id bigint NOT NULL,
  field_name text NOT NULL,
  field_type text NOT NULL,
  is_required boolean DEFAULT false,
  options text,
  order_index integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  compliance_enabled boolean DEFAULT true,
  compliance_mode character varying DEFAULT 'auto'::character varying,
  compliance_config jsonb,
  CONSTRAINT checklist_fields_pkey PRIMARY KEY (id),
  CONSTRAINT checklist_fields_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.checklist_templates(id)
);
CREATE TABLE public.checklist_folders (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  organization_id bigint,
  parent_id uuid,
  name text NOT NULL,
  slug text,
  path text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  color text DEFAULT '#3B82F6'::text,
  icon text DEFAULT 'folder'::text,
  display_order integer DEFAULT 0,
  description text,
  CONSTRAINT checklist_folders_pkey PRIMARY KEY (id),
  CONSTRAINT checklist_folders_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT checklist_folders_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.checklist_folders(id),
  CONSTRAINT checklist_folders_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.checklist_templates (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL,
  description text,
  category text,
  created_by text,
  created_by_user_id uuid,
  organization_id bigint,
  is_public boolean DEFAULT false,
  is_category_folder boolean DEFAULT false,
  folder_color text,
  folder_icon text,
  parent_category_id bigint,
  folder_id uuid,
  display_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  visibility character varying DEFAULT 'private'::character varying,
  shared_with text,
  CONSTRAINT checklist_templates_pkey PRIMARY KEY (id),
  CONSTRAINT checklist_templates_created_by_user_id_fkey FOREIGN KEY (created_by_user_id) REFERENCES public.users(id),
  CONSTRAINT checklist_templates_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT checklist_templates_parent_category_id_fkey FOREIGN KEY (parent_category_id) REFERENCES public.checklist_templates(id),
  CONSTRAINT checklist_templates_folder_id_fkey FOREIGN KEY (folder_id) REFERENCES public.checklist_folders(id)
);
CREATE TABLE public.checklists (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title text NOT NULL,
  organization_id bigint NOT NULL,
  created_by uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone,
  CONSTRAINT checklists_pkey PRIMARY KEY (id),
  CONSTRAINT checklists_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.checkout_attempts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lead_id integer,
  email_hash text NOT NULL,
  plan_slug text NOT NULL,
  step text DEFAULT 'started'::text CHECK (step = ANY (ARRAY['started'::text, 'lead_created'::text, 'user_created'::text, 'payment_initiated'::text, 'completed'::text, 'failed'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'success'::text, 'failed'::text, 'abandoned'::text])),
  error_code text,
  error_message text,
  asaas_customer_id text,
  asaas_subscription_id text,
  idempotency_key text NOT NULL UNIQUE,
  ip_address inet,
  user_agent text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  organization_id bigint,
  CONSTRAINT checkout_attempts_pkey PRIMARY KEY (id),
  CONSTRAINT checkout_attempts_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id),
  CONSTRAINT checkout_attempts_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.coupon_redemptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  coupon_id uuid NOT NULL,
  organization_id bigint NOT NULL,
  subscription_id uuid,
  saved_amount_cents integer NOT NULL,
  redeemed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupon_redemptions_pkey PRIMARY KEY (id),
  CONSTRAINT coupon_redemptions_coupon_id_fkey FOREIGN KEY (coupon_id) REFERENCES public.coupons(id),
  CONSTRAINT coupon_redemptions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT coupon_redemptions_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id)
);
CREATE TABLE public.coupons (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  code text NOT NULL UNIQUE,
  description text,
  discount_type text NOT NULL CHECK (discount_type = ANY (ARRAY['percentage'::text, 'fixed_amount'::text])),
  discount_value integer NOT NULL,
  max_uses integer,
  uses_count integer DEFAULT 0,
  expires_at timestamp with time zone,
  minimum_amount_cents integer,
  valid_for_plans jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT coupons_pkey PRIMARY KEY (id)
);
CREATE TABLE public.crm_activities (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  lead_id bigint NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['note'::text, 'call'::text, 'email'::text, 'meeting'::text, 'status_change'::text, 'whatsapp'::text])),
  title text NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT crm_activities_pkey PRIMARY KEY (id),
  CONSTRAINT crm_activities_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id),
  CONSTRAINT crm_activities_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.inspection_ata_segments (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  ata_id bigint NOT NULL,
  segment_number integer NOT NULL,
  audio_url text,
  duration_seconds integer DEFAULT 0,
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  uploaded boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_ata_segments_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_ata_segments_ata_id_fkey FOREIGN KEY (ata_id) REFERENCES public.inspection_atas(id)
);
CREATE TABLE public.inspection_atas (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  inspection_id bigint NOT NULL,
  organization_id bigint,
  created_by uuid,
  status text DEFAULT 'recording'::text CHECK (status = ANY (ARRAY['recording'::text, 'processing'::text, 'draft'::text, 'validated'::text])),
  total_duration_seconds integer DEFAULT 0,
  transcript text,
  summary text,
  identified_items jsonb DEFAULT '[]'::jsonb,
  doc_url text,
  created_at timestamp with time zone DEFAULT now(),
  validated_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_atas_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_atas_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT inspection_atas_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT inspection_atas_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.inspection_items (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  inspection_id bigint NOT NULL,
  category text,
  item_description text,
  is_compliant boolean,
  observations text,
  photo_url text,
  template_id bigint,
  field_responses text,
  ai_pre_analysis text,
  ai_action_plan text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  compliance_status text,
  CONSTRAINT inspection_items_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_items_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT inspection_items_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.checklist_templates(id)
);
CREATE TABLE public.inspection_logs (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  inspection_id bigint NOT NULL,
  user_id uuid NOT NULL,
  action text NOT NULL CHECK (action = ANY (ARRAY['CREATE'::text, 'UPDATE'::text, 'DELETE'::text, 'FINALIZE'::text, 'REOPEN'::text])),
  field_changed text,
  old_value text,
  new_value text,
  ip_address text,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_logs_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_logs_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT inspection_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.inspection_media (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  inspection_id bigint NOT NULL,
  inspection_item_id bigint,
  media_type text NOT NULL,
  file_name text,
  file_url text,
  file_size bigint,
  mime_type text,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  thumbnail_url text,
  latitude numeric,
  longitude numeric,
  captured_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_media_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_media_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT inspection_media_inspection_item_id_fkey FOREIGN KEY (inspection_item_id) REFERENCES public.inspection_items(id)
);
CREATE TABLE public.inspection_reopening_history (
  id integer NOT NULL DEFAULT nextval('inspection_reopening_history_id_seq'::regclass),
  inspection_id bigint NOT NULL,
  reopened_by uuid NOT NULL,
  reopened_at timestamp with time zone DEFAULT now(),
  justification text NOT NULL,
  previous_status text,
  previous_inspector_signature text,
  previous_responsible_signature text,
  previous_completed_date date,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_reopening_history_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_reopening_history_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id)
);
CREATE TABLE public.inspection_shares (
  id bigint NOT NULL DEFAULT nextval('inspection_shares_id_seq'::regclass),
  inspection_id bigint NOT NULL,
  share_token text NOT NULL UNIQUE,
  created_by uuid NOT NULL,
  permission text NOT NULL DEFAULT 'view'::text CHECK (permission = ANY (ARRAY['view'::text, 'edit'::text])),
  expires_at timestamp with time zone,
  is_active boolean NOT NULL DEFAULT true,
  access_count integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inspection_shares_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_shares_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT inspection_shares_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.inspection_status_history (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  inspection_id bigint,
  status_from text,
  status_to text NOT NULL,
  changed_by uuid,
  location_lat double precision,
  location_lng double precision,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT inspection_status_history_pkey PRIMARY KEY (id),
  CONSTRAINT inspection_status_history_inspection_id_fkey FOREIGN KEY (inspection_id) REFERENCES public.inspections(id),
  CONSTRAINT inspection_status_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES auth.users(id)
);
CREATE TABLE public.inspections (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  title text NOT NULL,
  description text,
  location text,
  inspector_name text,
  inspector_email text,
  company_name text,
  cep text,
  address text,
  latitude double precision,
  longitude double precision,
  scheduled_date timestamp with time zone,
  completed_date date,
  status text DEFAULT 'pendente'::text,
  priority text DEFAULT 'media'::text,
  created_by uuid,
  organization_id bigint,
  responsible_name text,
  responsible_email text,
  inspector_signature text,
  responsible_signature text,
  action_plan text,
  action_plan_type text,
  ai_assistant_id bigint,
  started_at_user_time timestamp with time zone,
  started_at_server_time timestamp with time zone DEFAULT now(),
  location_start_lat double precision,
  location_start_lng double precision,
  location_end_lat double precision,
  location_end_lng double precision,
  device_fingerprint text,
  device_model text,
  device_os text,
  is_offline_sync boolean DEFAULT false,
  sync_timestamp timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  compliance_enabled boolean DEFAULT true,
  logradouro text,
  numero text,
  complemento text,
  bairro text,
  cidade text,
  uf text,
  sectors text,
  client_id text,
  template_id bigint,
  participants jsonb DEFAULT '[]'::jsonb,
  accepted_by jsonb DEFAULT '[]'::jsonb,
  declined_by jsonb DEFAULT '[]'::jsonb,
  responsible_role character varying,
  CONSTRAINT inspections_pkey PRIMARY KEY (id),
  CONSTRAINT inspections_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT inspections_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT inspections_ai_assistant_id_fkey FOREIGN KEY (ai_assistant_id) REFERENCES public.ai_assistants(id)
);
CREATE TABLE public.integrations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id bigint NOT NULL,
  user_id uuid NOT NULL,
  provider text NOT NULL CHECK (provider = ANY (ARRAY['google'::text, 'outlook'::text, 'zoom'::text])),
  access_token text NOT NULL,
  refresh_token text,
  expires_at timestamp with time zone,
  scope text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT integrations_pkey PRIMARY KEY (id),
  CONSTRAINT integrations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT integrations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid,
  organization_id bigint NOT NULL,
  gateway_invoice_id text,
  payment_link text,
  pdf_url text,
  amount_cents integer NOT NULL,
  currency text DEFAULT 'BRL'::text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'paid'::text, 'overdue'::text, 'canceled'::text, 'refunded'::text, 'failed'::text])),
  due_date date,
  paid_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT invoices_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.kanban_columns (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  organization_id bigint,
  title text NOT NULL,
  status_key text NOT NULL,
  position integer NOT NULL DEFAULT 0,
  color text DEFAULT 'bg-slate-100'::text,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT kanban_columns_pkey PRIMARY KEY (id),
  CONSTRAINT kanban_columns_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.leads (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  company_name text NOT NULL,
  contact_name text,
  email text,
  phone text,
  status text NOT NULL DEFAULT 'new'::text CHECK (status = ANY (ARRAY['new'::text, 'contacted'::text, 'qualified'::text, 'proposal'::text, 'negotiation'::text, 'won'::text, 'lost'::text])),
  source text,
  owner_id uuid,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  cnpj text,
  razao_social text,
  nome_fantasia text,
  website text,
  cep text,
  logradouro text,
  numero text,
  complemento text,
  bairro text,
  cidade text,
  uf text,
  converted_organization_id bigint,
  deal_value numeric DEFAULT 0,
  probability integer DEFAULT 0,
  status_updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT leads_pkey PRIMARY KEY (id),
  CONSTRAINT leads_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES auth.users(id),
  CONSTRAINT leads_converted_organization_id_fkey FOREIGN KEY (converted_organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.migrations_log (
  id bigint NOT NULL DEFAULT nextval('migrations_log_id_seq'::regclass),
  migration_type text NOT NULL,
  details jsonb,
  items_migrated integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT migrations_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  title text NOT NULL,
  message text NOT NULL,
  type text DEFAULT 'info'::text CHECK (type = ANY (ARRAY['info'::text, 'success'::text, 'warning'::text, 'error'::text])),
  read boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  metadata jsonb,
  CONSTRAINT notifications_pkey PRIMARY KEY (id),
  CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.organizations (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  name text NOT NULL,
  razao_social text,
  nome_fantasia text,
  cnpj text,
  type text,
  contact_email text,
  contact_phone text,
  address text,
  is_active boolean DEFAULT true,
  parent_organization_id bigint,
  organization_level text DEFAULT 'company'::text,
  max_users integer DEFAULT 50,
  max_subsidiaries integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  description text,
  subscription_status text DEFAULT 'active'::text,
  subscription_plan text DEFAULT 'basic'::text,
  cnae_principal text,
  cnae_descricao text,
  natureza_juridica text,
  data_abertura text,
  capital_social text,
  porte_empresa text,
  situacao_cadastral text,
  numero_funcionarios text,
  setor_industria text,
  subsetor_industria text,
  certificacoes_seguranca text,
  data_ultima_auditoria text,
  nivel_risco text DEFAULT 'medio'::text,
  contato_seguranca_nome text,
  contato_seguranca_email text,
  contato_seguranca_telefone text,
  historico_incidentes text,
  observacoes_compliance text,
  website text,
  faturamento_anual text,
  logo_url text,
  ai_usage_count integer DEFAULT 0,
  ai_limit integer DEFAULT 100,
  ai_reset_date date DEFAULT ((date_trunc('month'::text, now()) + '1 mon'::interval))::date,
  subscription_tier text DEFAULT 'starter'::text,
  alert_50_sent boolean DEFAULT false,
  alert_80_sent boolean DEFAULT false,
  alert_100_sent boolean DEFAULT false,
  crm_deal_id text,
  crm_status text DEFAULT 'lead'::text,
  account_manager_id uuid,
  CONSTRAINT organizations_pkey PRIMARY KEY (id),
  CONSTRAINT organizations_parent_organization_id_fkey FOREIGN KEY (parent_organization_id) REFERENCES public.organizations(id),
  CONSTRAINT organizations_account_manager_id_fkey FOREIGN KEY (account_manager_id) REFERENCES public.users(id)
);
CREATE TABLE public.plans (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  display_name text NOT NULL,
  slug text NOT NULL UNIQUE,
  description text,
  price_cents integer NOT NULL DEFAULT 0,
  currency text NOT NULL DEFAULT 'BRL'::text,
  billing_period text NOT NULL CHECK (billing_period = ANY (ARRAY['monthly'::text, 'yearly'::text])),
  limits jsonb NOT NULL DEFAULT '{}'::jsonb,
  features jsonb NOT NULL DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_public boolean DEFAULT true,
  type text NOT NULL DEFAULT 'subscription'::text CHECK (type = ANY (ARRAY['subscription'::text, 'addon'::text, 'one_time'::text])),
  addon_config jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT plans_pkey PRIMARY KEY (id)
);
CREATE TABLE public.rate_limits (
  key text NOT NULL,
  points integer DEFAULT 0,
  expire_at timestamp with time zone,
  CONSTRAINT rate_limits_pkey PRIMARY KEY (key)
);
CREATE TABLE public.recurring_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id bigint NOT NULL,
  checklist_template_id bigint,
  rrule text NOT NULL,
  title text NOT NULL,
  description text,
  assignee_id uuid,
  default_duration_minutes integer DEFAULT 60,
  default_location jsonb,
  is_active boolean DEFAULT true,
  advance_days integer DEFAULT 7,
  last_generated_at timestamp with time zone,
  next_occurrence_at timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT recurring_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT recurring_schedules_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT recurring_schedules_checklist_template_id_fkey FOREIGN KEY (checklist_template_id) REFERENCES public.checklist_templates(id),
  CONSTRAINT recurring_schedules_assignee_id_fkey FOREIGN KEY (assignee_id) REFERENCES public.users(id),
  CONSTRAINT recurring_schedules_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.role_permissions (
  id integer NOT NULL DEFAULT nextval('role_permissions_id_seq'::regclass),
  role character varying NOT NULL,
  permission_type character varying NOT NULL,
  is_allowed boolean DEFAULT true,
  organization_id integer,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT role_permissions_pkey PRIMARY KEY (id),
  CONSTRAINT role_permissions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.session_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_id text NOT NULL,
  ip_address text,
  user_agent text,
  action text DEFAULT 'login'::text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT session_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id bigint NOT NULL,
  plan_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'trial'::text CHECK (status = ANY (ARRAY['trial'::text, 'active'::text, 'past_due'::text, 'grace_period'::text, 'suspended'::text, 'canceled'::text])),
  gateway_name text DEFAULT 'asaas'::text,
  gateway_customer_id text,
  gateway_subscription_id text,
  crm_deal_id text,
  mrr_value_cents integer,
  usage_limits_snapshot jsonb,
  current_period_start timestamp with time zone,
  current_period_end timestamp with time zone,
  trial_ends_at timestamp with time zone,
  canceled_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.plans(id)
);
CREATE TABLE public.system_email_config (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  service_provider text NOT NULL DEFAULT 'gmail'::text,
  email_address text NOT NULL,
  access_token text,
  refresh_token text NOT NULL,
  expires_at timestamp with time zone,
  client_id text,
  client_secret text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_email_config_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_goals (
  metric_key text NOT NULL,
  target_value numeric NOT NULL,
  period text DEFAULT 'monthly'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_goals_pkey PRIMARY KEY (metric_key)
);
CREATE TABLE public.system_settings (
  id text NOT NULL DEFAULT 'global'::text,
  ai_enabled boolean DEFAULT true,
  ai_primary_provider text DEFAULT 'gemini'::text,
  ai_backup_provider text DEFAULT 'openai'::text,
  ai_fallback_enabled boolean DEFAULT true,
  gamification_enabled boolean DEFAULT true,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT system_settings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.usage_metrics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id bigint NOT NULL,
  date date NOT NULL DEFAULT CURRENT_DATE,
  active_users_count integer DEFAULT 0,
  inspections_count integer DEFAULT 0,
  ai_analyses_count integer DEFAULT 0,
  storage_used_mb numeric DEFAULT 0,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT usage_metrics_pkey PRIMARY KEY (id),
  CONSTRAINT usage_metrics_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.user_achievements (
  user_id uuid NOT NULL,
  achievement_id integer NOT NULL,
  unlocked_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_achievements_pkey PRIMARY KEY (user_id, achievement_id),
  CONSTRAINT user_achievements_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_achievements_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievements(id)
);
CREATE TABLE public.user_credentials (
  user_id uuid NOT NULL,
  password_hash text NOT NULL,
  last_login_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_credentials_pkey PRIMARY KEY (user_id),
  CONSTRAINT user_credentials_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_gamification (
  user_id uuid NOT NULL,
  current_xp integer DEFAULT 0,
  level integer DEFAULT 1,
  points_this_month integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_gamification_pkey PRIMARY KEY (user_id),
  CONSTRAINT user_gamification_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.user_invitations (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  email text NOT NULL,
  invitation_token text NOT NULL UNIQUE,
  organization_id bigint,
  invited_by uuid,
  role text DEFAULT 'inspector'::text,
  expires_at timestamp with time zone NOT NULL,
  accepted_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_invitations_pkey PRIMARY KEY (id),
  CONSTRAINT user_invitations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT user_invitations_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id)
);
CREATE TABLE public.user_organizations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  organization_id bigint NOT NULL,
  role text NOT NULL DEFAULT 'inspector'::text,
  permissions jsonb DEFAULT '{}'::jsonb,
  is_primary boolean DEFAULT false,
  is_active boolean DEFAULT true,
  assigned_by uuid,
  assigned_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_organizations_pkey PRIMARY KEY (id),
  CONSTRAINT user_organizations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT user_organizations_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT user_organizations_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.users(id)
);
CREATE TABLE public.user_points_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  points integer NOT NULL,
  action text NOT NULL,
  description text,
  reference_type text,
  reference_id text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_points_history_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  token text NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  revoked_at timestamp with time zone,
  CONSTRAINT user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email text NOT NULL UNIQUE,
  name text,
  role text DEFAULT 'inspector'::text,
  can_manage_users boolean DEFAULT false,
  can_create_organizations boolean DEFAULT false,
  is_active boolean DEFAULT true,
  organization_id bigint,
  managed_organization_id bigint,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  approval_status text DEFAULT 'approved'::text,
  approved_by uuid,
  approved_at timestamp with time zone,
  rejection_reason text,
  last_active_at timestamp with time zone,
  phone text,
  avatar_url text,
  profile_completed boolean DEFAULT false,
  last_login_at timestamp with time zone,
  total_points integer DEFAULT 0,
  current_streak integer DEFAULT 0,
  level text DEFAULT 'iniciante'::text,
  current_session_id text,
  last_login_ip text,
  last_login_device text,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id),
  CONSTRAINT users_managed_organization_id_fkey FOREIGN KEY (managed_organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.webhook_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  gateway text NOT NULL,
  external_event_id text NOT NULL,
  event_type text NOT NULL,
  payload jsonb,
  processed_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'processed'::text,
  error_message text,
  CONSTRAINT webhook_events_pkey PRIMARY KEY (id)
);